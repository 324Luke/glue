import randomstring from 'randomstring'
import { ConfigObject } from './config.controller'
import { Document } from '../entities/document.entity'
import { Repository } from 'typeorm'

export class DocumentHandler {
  options: ConfigObject

  constructor (options: ConfigObject) {
    this.options = options
  }

  /*
   * Calls `randomstring.generate` until it finds a unique id for the document
   */
  private createID (): string {
    return randomstring.generate(this.options.idLength)
  }

  /*
   * Creates a connection to the database, then creates a new entry in the database consisting of:
   *  - Document ID, generated by the createID() function
   *  - Document content, provided by arguments
   */
  async newDocument (content: string, repository: Repository<Document>): Promise<object> {
    const id = this.createID()

    const doc = repository.create({
      id,
      content
    })

    repository.save(doc)

    return { ...doc }
  }
}
